{% extends 'base.html' %}

{% block title %}Credit Risk Assessment{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center">Credit Risk Assessment</h2>

 <!-- Batch Upload Form - FIXED URL -->
 <div class="my-4">
    <form action="{{ url_for('credit_batch_upload') }}" method="POST" enctype="multipart/form-data">
      <div class="input-group mb-3">
        <input type="file" name="file" class="form-control" accept=".csv,.xlsx" required>
        <button class="btn btn-success" type="submit">Batch Upload</button>
      </div>
      <small class="text-muted">Upload a CSV or Excel file to batch add Credit Risk Applications.</small>
    </form>
  </div>

  <div class="container my-4">
    <label for="fileUpload" class="form-label">üìÅ Upload Credit Risk File (CSV or Excel)</label>
    <input type="file" id="fileUpload" class="form-control" accept=".csv, .xlsx">
    <small class="text-muted">Only the first row will be used to autofill the form.</small>
  </div>

  <div id="preview-container" class="mt-4" style="display: none;">
  <h4>Preview of Credit Risk Applications</h4>
  <table id="preview-table" class="table table-bordered">
    <thead>
      <tr>
        <th>Application ID</th>
        <th>Loan Amount</th>
        <th>Property Value</th>
        <th>Monthly Debt</th>
        <th>Monthly Income</th>
        <th>Recovery Rate</th>
        <th>Probability of Default</th>
        <th>Risk Score</th>
        <th>Risk Level</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="confirm-upload" class="btn btn-success">Confirm Upload</button>
</div>
  
  <form method="POST" id="credit-risk-form" novalidate>
    <div class="row">
      <div class="col-md-6 mb-3">
        <label>Application ID</label>
        <input type="text" class="form-control" name="application_id" pattern="[A-Za-z0-9\-_.]+" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Loan Amount (RM)</label>
        <input type="number" class="form-control" name="loan_amount" step="0.01" min="0" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Property Value (RM)</label>
        <input type="number" class="form-control" name="property_value" step="0.01" min="0" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Monthly Debt (RM)</label>
        <input type="number" class="form-control" name="monthly_debt" step="0.01" min="0" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Monthly Income (RM)</label>
        <input type="number" class="form-control" name="monthly_income" step="0.01" min="0" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Recovery Rate (%)</label>
        <input type="number" class="form-control" name="recovery_rate" step="0.1" min="0" max="100" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Probability of Default (%)</label>
        <input type="number" class="form-control" name="probability_of_default" step="0.1" min="0" max="100" required>
      </div>

      <div class="col-12">
        <button type="submit" name="action" value="calculate" class="btn btn-primary btn-lg">
          <i class="fas fa-calculator"></i> Calculate Risk
        </button>
        <a href="{{ url_for('credit_applications') }}" class="btn btn-secondary btn-lg ml-2">
          <i class="fas fa-list"></i> View Applications
        </a>
      </div>
    </div>
  </form>

  <!-- Results Section -->
  {% if results %}
  <div class="mt-5">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h4>Risk Assessment Results</h4>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Risk Score:</strong> {{ risk_score | round(2) }}</p>
            <p><strong>Risk Level:</strong> 
              <span class="badge {% if risk_level == 'Low' %}badge-success{% elif risk_level == 'Medium' %}badge-warning{% else %}badge-danger{% endif %}">
                {{ risk_level }}
              </span>
            </p>
          </div>
          <div class="col-md-6">
            {% for key, value in results.items() %}
            <p><strong>{{ key.replace('_', ' ').title() }}:</strong> {{ value }}</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
document.getElementById('fileUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/upload-credit-file', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Autofill the form with the first row data
                document.querySelector('input[name="application_id"]').value = data.application_id || '';
                document.querySelector('input[name="loan_amount"]').value = data.loan_amount || '';
                document.querySelector('input[name="property_value"]').value = data.property_value || '';
                document.querySelector('input[name="monthly_debt"]').value = data.monthly_debt || '';
                document.querySelector('input[name="monthly_income"]').value = data.monthly_income || '';
                document.querySelector('input[name="recovery_rate"]').value = data.recovery_rate || '';
                document.querySelector('input[name="probability_of_default"]').value = data.probability_of_default || '';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error uploading file');
        });
    }
});
</script>
{% endblock %}