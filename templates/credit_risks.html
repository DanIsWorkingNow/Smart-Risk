{% extends 'base.html' %}

{% block title %}Credit Risk Assessment{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center">Credit Risk Assessment</h2>

  <!-- Batch Upload Form -->
  <div class="my-4">
    <form action="{{ url_for('credit_batch_upload') }}" method="POST" enctype="multipart/form-data">
      <div class="input-group mb-3">
        <input type="file" name="file" class="form-control" accept=".csv,.xlsx" required>
        <button class="btn btn-success" type="submit">Batch Upload</button>
      </div>
      <small class="text-muted">Upload a CSV or Excel file to batch add Credit Risk Applications.</small>
    </form>
  </div>

  <div class="container my-4">
    <label for="fileUpload" class="form-label">üìÅ Upload Credit Risk File (CSV or Excel)</label>
    <input type="file" id="fileUpload" class="form-control" accept=".csv, .xlsx">
    <small class="text-muted">Only the first row will be used to autofill the form.</small>
  </div>

  <div id="preview-container" class="mt-4" style="display: none;">
    <h4>Preview of Credit Risk Applications</h4>
    <table id="preview-table" class="table table-bordered">
      <thead>
        <tr>
          <th>Application ID</th>
          <th>Loan Amount</th>
          <th>Property Value</th>
          <th>Monthly Debt</th>
          <th>Monthly Income</th>
          <th>Recovery Rate</th>
          <th>Probability of Default</th>
          <th>Risk Score</th>
          <th>Risk Level</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="confirm-upload" class="btn btn-success">Confirm Upload</button>
  </div>
  
  <form method="POST" id="credit-risk-form" novalidate>
    <div class="row">
      <div class="col-md-6 mb-3">
        <label>Application ID</label>
        <input type="text" class="form-control" name="application_id" pattern="[A-Za-z0-9\-_.]+" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Loan Amount (RM)</label>
        <input type="number" class="form-control" name="loan_amount" step="0.01" min="0" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Property Value (RM)</label>
        <input type="number" class="form-control" name="property_value" step="0.01" min="0" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Monthly Debt (RM)</label>
        <input type="number" class="form-control" name="monthly_debt" step="0.01" min="0" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Monthly Income (RM)</label>
        <input type="number" class="form-control" name="monthly_income" step="0.01" min="0" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Recovery Rate (%)</label>
        <input type="number" class="form-control" name="recovery_rate" step="0.1" min="0" max="100" required>
      </div>

      <div class="col-md-6 mb-3">
        <label>Probability of Default (%)</label>
        <input type="number" class="form-control" name="probability_of_default" step="0.1" min="0" max="100" required>
      </div>

      <div class="col-12">
        <button type="submit" name="action" value="calculate" class="btn btn-primary btn-lg">
          <i class="fas fa-calculator"></i> Calculate Risk
        </button>
        
        <!-- ADDED SAVE BUTTON - THIS WAS MISSING -->
        {% if results %}
        <button type="submit" name="action" value="save" class="btn btn-success btn-lg ml-2">
          <i class="fas fa-save"></i> Save Assessment
        </button>
        {% endif %}
        
        <a href="{{ url_for('credit_applications') }}" class="btn btn-secondary btn-lg ml-2">
          <i class="fas fa-list"></i> View Applications
        </a>
      </div>
    </div>
  </form>

  <!-- Results Section -->
  {% if results %}
  <div class="mt-5">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h4>Risk Assessment Results</h4>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Risk Score:</strong> {{ risk_score | round(2) }}</p>
            <p><strong>Risk Level:</strong> 
              <span class="badge {% if risk_level == 'Low' %}badge-success{% elif risk_level == 'Medium' %}badge-warning{% else %}badge-danger{% endif %}">
                {{ risk_level }}
              </span>
            </p>
          </div>
          <div class="col-md-6">
            {% for key, value in results.items() %}
            <p><strong>{{ key.replace('_', ' ').title() }}:</strong> {{ value }}</p>
            {% endfor %}
          </div>
        </div>
        
        <!-- SAVE BUTTON ALSO HERE FOR CONVENIENCE -->
        <div class="mt-3">
          <form method="POST" style="display: inline;">
            <!-- Hidden fields to preserve the calculated values -->
            <input type="hidden" name="application_id" value="{{ request.form.get('application_id', '') }}">
            <input type="hidden" name="loan_amount" value="{{ request.form.get('loan_amount', '') }}">
            <input type="hidden" name="property_value" value="{{ request.form.get('property_value', '') }}">
            <input type="hidden" name="monthly_debt" value="{{ request.form.get('monthly_debt', '') }}">
            <input type="hidden" name="monthly_income" value="{{ request.form.get('monthly_income', '') }}">
            <input type="hidden" name="recovery_rate" value="{{ request.form.get('recovery_rate', '') }}">
            <input type="hidden" name="probability_of_default" value="{{ request.form.get('probability_of_default', '') }}">
            
            <button type="submit" name="action" value="save" class="btn btn-success btn-lg">
              <i class="fas fa-save"></i> Save This Assessment
            </button>
          </form>
          
          <button onclick="calculateAnother()" class="btn btn-info btn-lg ml-2">
            <i class="fas fa-redo"></i> Calculate Another
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
// File upload functionality
document.getElementById('fileUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/upload-credit-file', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Autofill the form with the first row data
                const form = document.getElementById('credit-risk-form');
                Object.keys(data.data).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = data.data[key];
                    }
                });
                
                // Show preview
                showPreview(data.preview);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error processing file');
        });
    }
});

function showPreview(preview) {
    const container = document.getElementById('preview-container');
    const tbody = container.querySelector('tbody');
    
    tbody.innerHTML = '';
    preview.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.application_id || ''}</td>
            <td>${row.loan_amount || ''}</td>
            <td>${row.property_value || ''}</td>
            <td>${row.monthly_debt || ''}</td>
            <td>${row.monthly_income || ''}</td>
            <td>${row.recovery_rate || ''}</td>
            <td>${row.probability_of_default || ''}</td>
            <td>${row.risk_score || 'Not calculated'}</td>
            <td>${row.risk_level || 'Not calculated'}</td>
        `;
        tbody.appendChild(tr);
    });
    
    container.style.display = 'block';
}

// Function to reset form for another calculation
function calculateAnother() {
    document.getElementById('credit-risk-form').reset();
    // Hide results section by reloading the page
    window.location.href = window.location.pathname;
}

// Form validation
document.getElementById('credit-risk-form').addEventListener('submit', function(e) {
    const formData = new FormData(this);
    const action = e.submitter.value;
    
    // Basic validation
    const requiredFields = ['application_id', 'loan_amount', 'property_value', 'monthly_debt', 'monthly_income', 'recovery_rate', 'probability_of_default'];
    
    for (let field of requiredFields) {
        if (!formData.get(field)) {
            e.preventDefault();
            alert(`Please fill in the ${field.replace('_', ' ')} field.`);
            return;
        }
    }
    
    // Show loading state
    const submitBtn = e.submitter;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    submitBtn.disabled = true;
    
    // Re-enable button after a delay (in case of errors)
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 5000);
});

// Auto-calculate LTV and DTI as user types
document.addEventListener('DOMContentLoaded', function() {
    const loanAmount = document.querySelector('[name="loan_amount"]');
    const propertyValue = document.querySelector('[name="property_value"]');
    const monthlyDebt = document.querySelector('[name="monthly_debt"]');
    const monthlyIncome = document.querySelector('[name="monthly_income"]');
    
    function calculateRatios() {
        if (loanAmount.value && propertyValue.value) {
            const ltv = (parseFloat(loanAmount.value) / parseFloat(propertyValue.value) * 100).toFixed(2);
            // You can display this somewhere if needed
        }
        
        if (monthlyDebt.value && monthlyIncome.value) {
            const dti = (parseFloat(monthlyDebt.value) / parseFloat(monthlyIncome.value) * 100).toFixed(2);
            // You can display this somewhere if needed
        }
    }
    
    [loanAmount, propertyValue, monthlyDebt, monthlyIncome].forEach(input => {
        input.addEventListener('input', calculateRatios);
    });
});
</script>

<style>
.badge {
    font-size: 0.9em;
    padding: 0.5em 0.8em;
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
}

.card-header h4 {
    margin: 0;
}

#preview-container {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
{% endblock %}