{% extends 'base.html' %}

{% block title %}Credit Risk Applications{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4><i class="fas fa-list mr-2"></i>Credit Risk Applications</h4>
                        <a href="{{ url_for('credit_risk_page') }}" class="btn btn-light">
                            <i class="fas fa-plus mr-1"></i>New Assessment
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    
                    <!-- Status Filter Buttons -->
                    <div class="mb-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary active" onclick="filterByStatus('all')">
                                <i class="fas fa-list mr-1"></i>All ({{ applications|length }})
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="filterByStatus('pending')">
                                <i class="fas fa-clock mr-1"></i>Pending ({{ applications|selectattr('status', 'equalto', 'Pending')|list|length }})
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="filterByStatus('assessed')">
                                <i class="fas fa-calculator mr-1"></i>Assessed ({{ applications|selectattr('status', 'equalto', 'Assessed')|list|length }})
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="filterByStatus('approved')">
                                <i class="fas fa-check-circle mr-1"></i>Approved ({{ applications|selectattr('status', 'equalto', 'Approved')|list|length }})
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="filterByStatus('rejected')">
                                <i class="fas fa-times-circle mr-1"></i>Rejected ({{ applications|selectattr('status', 'equalto', 'Rejected')|list|length }})
                            </button>
                        </div>
                    </div>

                    {% if applications %}
                    <!-- Bulk Actions -->
                    <div class="mb-3">
                        <form method="POST" action="{{ url_for('delete_selected_credit_applications') }}" style="display: inline;">
                            <button type="submit" class="btn btn-outline-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to delete selected applications?')">
                                <i class="fas fa-trash mr-1"></i>Delete Selected
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm ml-2" onclick="selectAll()">
                                <i class="fas fa-check-square mr-1"></i>Select All
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm ml-1" onclick="clearSelection()">
                                <i class="fas fa-square mr-1"></i>Clear All
                            </button>
                    </div>

                    <!-- Applications Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="applicationsTable">
                            <thead class="bg-primary text-white">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="selectAllCheck" onchange="toggleAllRows()">
                                    </th>
                                    <th>Application ID</th>
                                    <th>Loan Amount (RM)</th>
                                    <th>Risk Score</th>
                                    <th>Risk Level</th>
                                    <th>Status</th>
                                    <th>Assessed By</th>
                                    <th>Approved By</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for app in applications %}
                                <tr data-status="{{ app.status.lower() }}">
                                    <td>
                                        <input type="checkbox" name="selected_ids" value="{{ app.id }}" class="row-select">
                                    </td>
                                    <td>
                                        <strong>{{ app.application_id }}</strong>
                                    </td>
                                    <td>{{ "{:,.2f}".format(app.loan_amount) }}</td>
                                    <td>
                                        <span class="badge badge-{% if app.risk_score < 30 %}success{% elif app.risk_score < 60 %}warning{% else %}danger{% endif %}">
                                            {{ app.risk_score|round(2) }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge badge-{% if app.risk_level == 'Low' %}success{% elif app.risk_level == 'Medium' %}warning{% else %}danger{% endif %}">
                                            {{ app.risk_level }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if app.status == 'Approved' %}
                                            <span class="badge badge-success"><i class="fas fa-check-circle mr-1"></i>Approved</span>
                                        {% elif app.status == 'Rejected' %}
                                            <span class="badge badge-danger"><i class="fas fa-times-circle mr-1"></i>Rejected</span>
                                        {% elif app.status == 'Assessed' %}
                                            <span class="badge badge-info"><i class="fas fa-calculator mr-1"></i>Assessed</span>
                                        {% else %}
                                            <span class="badge badge-warning"><i class="fas fa-clock mr-1"></i>Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if app.creator %}
                                            <small>{{ app.creator.full_name or app.creator.staff_id }}</small>
                                        {% else %}
                                            <small class="text-muted">Unknown</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if app.approver %}
                                            <small>{{ app.approver.full_name or app.approver.staff_id }}</small>
                                            {% if app.approved_at %}
                                                <br><small class="text-muted">{{ app.approved_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                            {% endif %}
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ app.created_at.strftime('%Y-%m-%d') if app.created_at else 'N/A' }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <!-- View/Edit Assessment -->
                                            <a href="{{ url_for('credit_risk_page') }}?app_id={{ app.application_id }}" 
                                               class="btn btn-outline-primary btn-sm" title="View/Edit Assessment">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            
                                            <!-- Quick Approve (if not already approved/rejected) -->
                                            {% if app.status not in ['Approved', 'Rejected'] %}
                                            <form method="POST" action="{{ url_for('quick_approve_application', app_id=app.id) }}" 
                                                  style="display: inline;" onsubmit="return confirm('Approve this application?')">
                                                <button type="submit" class="btn btn-outline-success btn-sm" title="Quick Approve">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>
                                            <form method="POST" action="{{ url_for('quick_reject_application', app_id=app.id) }}" 
                                                  style="display: inline;" onsubmit="return confirm('Reject this application?')">
                                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Quick Reject">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </form>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Credit Risk Applications Found</h5>
                        <p class="text-muted">Start by creating a new credit risk assessment.</p>
                        <a href="{{ url_for('credit_risk_page') }}" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i>Create First Assessment
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Status filtering
    function filterByStatus(status) {
        const rows = document.querySelectorAll('#applicationsTable tbody tr');
        const buttons = document.querySelectorAll('.btn-group .btn');
        
        // Update active button
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // Filter rows
        rows.forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            if (status === 'all' || rowStatus === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Selection functions
    function selectAll() {
        document.querySelectorAll('.row-select:not([style*="display: none"])').forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectAllCheckbox();
    }

    function clearSelection() {
        document.querySelectorAll('.row-select').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectAllCheckbox();
    }

    function toggleAllRows() {
        const selectAll = document.getElementById('selectAllCheck');
        const visibleCheckboxes = document.querySelectorAll('.row-select:not([style*="display: none"])');
        
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    }

    function updateSelectAllCheckbox() {
        const checkboxes = document.querySelectorAll('.row-select:not([style*="display: none"])');
        const checkedCount = document.querySelectorAll('.row-select:not([style*="display: none"]):checked').length;
        const selectAllCheck = document.getElementById('selectAllCheck');
        
        selectAllCheck.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
        selectAllCheck.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    }

    // Initialize DataTable
    $(document).ready(function() {
        $('#applicationsTable').DataTable({
            pageLength: 25,
            order: [[8, 'desc']], // Sort by date descending
            columnDefs: [
                { orderable: false, targets: [0, 9] } // Disable sorting on checkbox and actions
            ]
        });
        
        // Update select all when individual checkboxes change
        document.querySelectorAll('.row-select').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectAllCheckbox);
        });
    });
</script>

{% endblock %}